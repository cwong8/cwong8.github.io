<!DOCTYPE html>
<html lang="en">
  
  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139929620-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-139929620-1');
  </script>

  <meta charset="UTF-8">
  <title>cwong8.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/cayman.css">
</head>

  <body>
    <section class="page-header">
      <h1 class="project-name"><a href="http://localhost:4000"><font color="white">Christopher Wong</font></a></h1>
      <a href="/about/" class="btn">About</a>
      <a href="/resume/Christopher.Wong.pdf" class="btn">Resume</a>
      <a href="mailto:cwong680@gmail.com" class="btn">Email me</a>
      <h2 class="page-name"><font color="white" size="22">K shortest simple paths</font></h2>
    </section>

    <section class="main-content">
      
      <h1 id="k-shortest-simple-paths">K shortest simple paths</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Importing packages
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>

<span class="c1"># Display settings
</span><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># Server connection to MySQL:
</span><span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span> <span class="s">"localhost"</span><span class="p">,</span>
                  <span class="n">user</span><span class="o">=</span><span class="s">"yourusername"</span><span class="p">,</span>
                  <span class="n">passwd</span><span class="o">=</span><span class="s">"yourpassword"</span><span class="p">,</span>
                  <span class="n">db</span><span class="o">=</span><span class="s">"bdodae_new"</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="c1"># Importing SQL data
</span><span class="n">node</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SELECT * FROM node;"</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">conn</span><span class="p">)</span>

<span class="c1"># Create connection/adjacency matrix weighted with CP costs
</span><span class="n">cp_connection_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">]))),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">])</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s">"connections"</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">]):</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">", "</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">connected_nodes</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
        <span class="c1"># Edges going into cities have weight 0 and thus disappear from our graph, but we don't want this to happen
</span>        <span class="c1"># So we will instead set their weights to a very small value
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">connected_nodes</span><span class="p">][</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">cp_connection_matrix</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">connected_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.000000001</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cp_connection_matrix</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">connected_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">connected_nodes</span><span class="p">][</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Import networkx
</span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="n">nx</span>

<span class="c1"># Create graph
</span><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_numpy_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">cp_connection_matrix</span><span class="p">),</span> <span class="n">create_using</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">())</span>
<span class="c1"># Add node attributes
</span><span class="n">node_attributes</span> <span class="o">=</span> <span class="n">node</span><span class="p">[[</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"cp"</span><span class="p">,</span> <span class="s">"area"</span><span class="p">,</span> <span class="s">"type"</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s">'index'</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_attributes</span><span class="p">)</span>

<span class="c1">### Helper functions
# Takes in list as input (use get_nx_node_id for a single node)
</span><span class="k">def</span> <span class="nf">get_node_id</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span><span class="p">([</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">name</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_node_name</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s">'name'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_total_cp</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s">'cp'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_nx_node_id</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get the total value of each subnode
</span><span class="n">subnode_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"""
SELECT item_yield.node_name, item_price.subnode_id, item_yield.subnode_name, item_yield.cp,
    SUM(item_price.user_average * item_yield.amount) AS subnode_value_user,
    SUM(item_price.recent_value * item_yield.amount) AS subnode_value_recent,
    SUM(item_price.vendor_sell * item_yield.amount) AS subnode_value_vendor
FROM
    (SELECT subnode_item.subnode_id, item.name, prices.*
    FROM subnode_item JOIN item ON subnode_item.item_id = item.item_id
      JOIN prices ON item.item_id = prices.item_id
    ORDER BY subnode_item.subnode_id, item.item_id) AS item_price
    JOIN
    (SELECT subnode.subnode_id, item.item_id, item.name, yield.amount, subnode.name AS subnode_name, subnode.cp, node.name AS node_name
    FROM subnode JOIN yield ON subnode.subnode_id = yield.subnode_id
      JOIN item ON yield.item_id = item.item_id
      JOIN node ON subnode.node_id = node.node_id
    ORDER BY subnode.subnode_id, item.item_id) AS item_yield
    ON item_price.subnode_id = item_yield.subnode_id
        AND item_price.item_id = item_yield.item_id
        AND item_price.name = item_yield.name
GROUP BY item_price.subnode_id
ORDER BY item_price.subnode_id
"""</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">conn</span><span class="p">)</span>

<span class="c1"># Add per CP values
</span><span class="n">subnode_values</span><span class="p">[</span><span class="s">"subnode_value_user_per_cp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnode_values</span><span class="p">[</span><span class="s">"subnode_value_user"</span><span class="p">]</span> <span class="o">/</span> <span class="n">subnode_values</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span>
<span class="n">subnode_values</span><span class="p">[</span><span class="s">"subnode_value_recent_per_cp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnode_values</span><span class="p">[</span><span class="s">"subnode_value_recent"</span><span class="p">]</span> <span class="o">/</span> <span class="n">subnode_values</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span>

<span class="c1"># Add subnode values to node graph G
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subnode_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1000</span><span class="p">:</span> <span class="p">{</span><span class="s">"subnode_value_user"</span><span class="p">:</span> <span class="n">subnode_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">"subnode_value_user"</span><span class="p">],</span>
                                        <span class="s">"subnode_value_recent"</span><span class="p">:</span> <span class="n">subnode_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">"subnode_value_recent"</span><span class="p">],</span>
                                        <span class="s">"subnode_value_vendor"</span><span class="p">:</span> <span class="n">subnode_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">"subnode_value_vendor"</span><span class="p">]}})</span>
    
<span class="c1"># Adding subnode ranks based on their value per CP
</span><span class="n">subnode_values</span><span class="p">[</span><span class="s">"value_rank"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnode_values</span><span class="p">[</span><span class="s">"subnode_value_user_per_cp"</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">subnode_values</span><span class="p">[</span><span class="s">"recent_rank"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnode_values</span><span class="p">[</span><span class="s">"subnode_value_recent_per_cp"</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">itertools</span>
<span class="c1"># Find the k shortest paths using CP costs as edge weights
</span><span class="k">def</span> <span class="nf">k_shortest_paths</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="s">'weight'</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">shortest_simple_paths</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">),</span> <span class="n">k</span><span class="p">))</span>

<span class="c1"># k = 20 is arbitrarily chosen, we will tune this later
</span><span class="n">paths</span> <span class="o">=</span> <span class="n">k_shortest_paths</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">get_node_id</span><span class="p">([</span><span class="s">"Calpheon"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">get_node_id</span><span class="p">([</span><span class="s">"Altinova"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 101, 97, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 328, 38, 160, 23, 22]
[69, 101, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 208, 332, 176, 38, 160, 23, 22]
[69, 122, 219, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 298, 28, 29, 74, 316, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 171, 12, 328, 38, 160, 23, 22]
[69, 101, 97, 61, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 329, 189, 227, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 227, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 329, 189, 227, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 227, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 241, 109, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 208, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 176, 364, 25, 1, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 176, 38, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 208, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 176, 364, 25, 1, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 176, 38, 255, 40, 23, 22]
[69, 101, 97, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 101, 97, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 101, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 101, 122, 220, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 176, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 230, 109, 78, 318, 332, 176, 38, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 78, 318, 332, 176, 38, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 316, 227, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 0, 2, 7, 22]
[69, 101, 97, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 328, 38, 255, 40, 23, 22]
[69, 101, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 255, 40, 23, 22]
[69, 122, 101, 97, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 219, 238, 261, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 298, 28, 29, 171, 12, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 298, 28, 29, 74, 329, 189, 227, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 298, 28, 29, 74, 316, 227, 255, 40, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 329, 189, 227, 255, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 227, 255, 38, 160, 23, 22]
[69, 101, 97, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 328, 38, 160, 23, 22]
[69, 101, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 328, 38, 160, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 316, 227, 255, 327, 23, 22]
[69, 101, 97, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 171, 29, 74, 316, 328, 38, 255, 327, 23, 22]
[69, 101, 122, 220, 260, 65, 244, 206, 155, 108, 171, 12, 328, 38, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 298, 28, 29, 74, 329, 189, 227, 255, 327, 23, 22]
[69, 122, 220, 260, 65, 244, 206, 155, 108, 298, 28, 29, 74, 316, 227, 255, 327, 23, 22]
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Works best if you have a lot of CP, because this assumes you will take all subnodes
# Very greedy algorithm, seeks to maximize value per CP along a single path, ignoring potentially better neighboring nodes
</span><span class="k">def</span> <span class="nf">get_best_path</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="s">"""
    Gets the best value per CP path from paths generated by k_shortest_paths
    
    Args:
        paths: Output generated from k_shortest_paths
            Ex. paths = k_shortest_paths(G, get_node_id(["Calpheon"])[0], get_node_id(["Altinova"])[0], 20)
        output: Option to print detailed output. Set output = True to see this.
        
    Returns:
        The best value per CP path out of the k paths generated by k_shortest_paths
    """</span>
    <span class="n">path_df_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># For each path generated by k_shortest_paths, get a dataframe containing all subnodes connected to nodes in the path
</span>    <span class="c1"># and then sum all values to get path value and additional CP cost
</span>    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">path_subnode_values_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>   
        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path_subnode_values_df</span> <span class="o">=</span> <span class="n">path_subnode_values_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subnode_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subnode_values</span><span class="p">[</span><span class="s">"node_name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">][</span><span class="s">"name"</span><span class="p">]])</span>
        <span class="n">path_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_subnode_values_df</span><span class="p">)</span>
        
    <span class="c1"># Very messy, just summing up values for each path (naive approach)
</span>    <span class="n">path_node_cp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path_subnode_cp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path_subnode_value_user</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path_subnode_value_recent</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path_subnode_value_vendor</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">path_df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">path_df_list</span><span class="p">):</span>
        <span class="n">path_node_cp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">path_subnode_cp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
        <span class="n">path_subnode_value_user</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_df</span><span class="p">[</span><span class="s">"subnode_value_user"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
        <span class="n">path_subnode_value_recent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_df</span><span class="p">[</span><span class="s">"subnode_value_recent"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
        <span class="n">path_subnode_value_vendor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_df</span><span class="p">[</span><span class="s">"subnode_value_vendor"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
        
    <span class="c1"># Element-wise addition of 2 lists
</span>    <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">add</span>

    <span class="n">path_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s">"path"</span><span class="p">:</span> <span class="n">paths</span><span class="p">,</span>
        <span class="s">"total_cp"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">path_node_cp</span><span class="p">,</span> <span class="n">path_subnode_cp</span><span class="p">)),</span>
        <span class="s">"value_user"</span><span class="p">:</span> <span class="n">path_subnode_value_user</span><span class="p">,</span>
        <span class="s">"value_recent"</span><span class="p">:</span> <span class="n">path_subnode_value_recent</span><span class="p">,</span>
        <span class="s">"value_vendor"</span><span class="p">:</span> <span class="n">path_subnode_value_vendor</span>
    <span class="p">})</span>
    
    <span class="c1"># Add value per CP for each path
</span>    <span class="n">path_values</span><span class="p">[</span><span class="s">"value_user_per_cp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_values</span><span class="p">[</span><span class="s">"value_user"</span><span class="p">]</span> <span class="o">/</span> <span class="n">path_values</span><span class="p">[</span><span class="s">"total_cp"</span><span class="p">]</span>
    <span class="n">path_values</span><span class="p">[</span><span class="s">"value_recent_per_cp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_values</span><span class="p">[</span><span class="s">"value_recent"</span><span class="p">]</span> <span class="o">/</span> <span class="n">path_values</span><span class="p">[</span><span class="s">"total_cp"</span><span class="p">]</span>
    
    <span class="c1"># Get the best path and its subnodes
</span>    <span class="n">best_path</span> <span class="o">=</span> <span class="n">path_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">path_values</span><span class="p">[</span><span class="s">"value_user_per_cp"</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()][</span><span class="s">"path"</span><span class="p">]</span>
    <span class="n">best_subnodes_df</span> <span class="o">=</span> <span class="n">path_df_list</span><span class="p">[</span><span class="n">path_values</span><span class="p">[</span><span class="s">"value_user_per_cp"</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
    
    <span class="c1"># Print output if turned on
</span>    <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Start: "</span> <span class="o">+</span> <span class="n">get_node_name</span><span class="p">(</span><span class="n">best_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">" | End: "</span> <span class="o">+</span> <span class="n">get_node_name</span><span class="p">(</span><span class="n">best_path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">best_path</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Node CP cost: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">best_path</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Subnode CP cost: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_subnodes_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Total CP cost: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">best_path</span><span class="p">)</span> <span class="o">+</span> <span class="n">best_subnodes_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Path value: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_subnodes_df</span><span class="p">[</span><span class="s">"subnode_value_user"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Path value per CP: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_subnodes_df</span><span class="p">[</span><span class="s">"subnode_value_user"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">best_path</span><span class="p">)</span> <span class="o">+</span> <span class="n">best_subnodes_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())))</span>
    
    <span class="c1"># Returns best path and corresponding subnode dataframe
</span>    <span class="k">return</span><span class="p">(</span><span class="n">best_path</span><span class="p">,</span> <span class="n">best_subnodes_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Demonstration of get_best_path
</span><span class="n">get_best_path</span><span class="p">(</span><span class="n">k_shortest_paths</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">get_node_id</span><span class="p">([</span><span class="s">"Calpheon"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">get_node_id</span><span class="p">([</span><span class="s">"Altinova"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">20</span><span class="p">),</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Start: Calpheon | End: Altinova
	Node CP cost: 21
	Subnode CP cost: 24
	Total CP cost: 45
	Path value: 165422.21986860037
	Path value per CP: 3676.0493304133415





([69,
  122,
  220,
  260,
  65,
  244,
  206,
  155,
  108,
  171,
  29,
  74,
  329,
  189,
  227,
  255,
  40,
  23,
  22],
                       node_name  subnode_id  \
 162                    Oze Pass         163   
 149  Northern Plain Of Serendia         150   
 150  Northern Plain Of Serendia         151   
 ..                          ...         ...   
 140                Mediah Shore         141   
 158              Omar Lava Cave         159   
 159              Omar Lava Cave         160   
 
                                  subnode_name  cp  subnode_value_user  \
 162                    Oze Pass - Lumbering.1   1        10570.759717   
 149  Northern Plain Of Serendia - Gathering.1   1         2826.930099   
 150  Northern Plain Of Serendia - Lumbering.2   1         6183.050148   
 ..                                        ...  ..                 ...   
 140                   Mediah Shore - Mining.1   3        10792.679879   
 158                 Omar Lava Cave - Mining.1   3        14428.530141   
 159                 Omar Lava Cave - Mining.2   3        15385.450207   
 
      subnode_value_recent  subnode_value_vendor  subnode_value_user_per_cp  \
 162          13332.749623           1626.549969               10570.759717   
 149           3481.250122            261.510009                2826.930099   
 150           6242.200157           1148.250031                6183.050148   
 ..                    ...                   ...                        ...   
 140          11103.299851           1932.789973                3597.559960   
 158          38878.100433           2127.240011                4809.510047   
 159          44988.250780           2707.420044                5128.483402   
 
      subnode_value_recent_per_cp  value_rank  recent_rank  
 162                 13332.749623        67.0         68.0  
 149                  3481.250122       178.0        175.0  
 150                  6242.200157        91.0        128.0  
 ..                           ...         ...          ...  
 140                  3701.099950       160.0        170.0  
 158                 12959.366811       126.0         73.0  
 159                 14996.083593       117.0         55.0  
 
 [12 rows x 11 columns])
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">optimize_paths</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="s">"""
    Extension of the get_best_path function. Can take multiple start and end location pairings and will combine results into
    one final path removing duplicates.
    
    Args:
        locations: Pairings of start and end locations. They should both be start nodes.
            Ex. [("Calpheon", "Altinova"), ("Calpheon", "Heidel"), ("Heidel", "Velia")]
        output: Option to print detailed output. Set output = True to see this.
        
    Returns:
        One master path that connects all location pairings given as input.   
    """</span>
    <span class="n">master_path_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">master_path</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">path_location</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">path_df</span> <span class="o">=</span> <span class="n">get_best_path</span><span class="p">(</span><span class="n">k_shortest_paths</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">get_node_id</span><span class="p">([</span><span class="n">path_location</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">get_node_id</span><span class="p">([</span><span class="n">path_location</span><span class="p">[</span><span class="mi">1</span><span class="p">]])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">20</span><span class="p">),</span> <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">master_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">master_path_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">master_path_df</span><span class="p">,</span> <span class="n">path_df</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Print a line for cleaner output
</span>            <span class="k">print</span><span class="p">(</span><span class="s">"_______________________________________________________________________________________________________________"</span><span class="p">)</span>
    
    <span class="c1"># Output
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"Combining paths..."</span><span class="p">)</span>
    <span class="n">master_path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">master_path</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Cleaning subnode dataframes..."</span><span class="p">)</span>
    <span class="n">master_path_df</span> <span class="o">=</span> <span class="n">master_path_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"_______________________________"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Node CP: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">master_path</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Subnode CP: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">master_path_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Total CP: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">master_path</span><span class="p">)</span> <span class="o">+</span> <span class="n">master_path_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Total value: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">master_path_df</span><span class="p">[</span><span class="s">"subnode_value_user"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Value per CP: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">master_path_df</span><span class="p">[</span><span class="s">"subnode_value_user"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">get_total_cp</span><span class="p">(</span><span class="n">master_path</span><span class="p">)</span> <span class="o">+</span> <span class="n">master_path_df</span><span class="p">[</span><span class="s">"cp"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())))</span>
    
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Demonstration of optimize_paths
</span><span class="n">optimize_paths</span><span class="p">([(</span><span class="s">"Calpheon"</span><span class="p">,</span> <span class="s">"Altinova"</span><span class="p">),</span> <span class="p">(</span><span class="s">"Calpheon"</span><span class="p">,</span> <span class="s">"Heidel"</span><span class="p">),</span> <span class="p">(</span><span class="s">"Heidel"</span><span class="p">,</span> <span class="s">"Velia"</span><span class="p">)],</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Start: Calpheon | End: Altinova
	Node CP cost: 21
	Subnode CP cost: 24
	Total CP cost: 45
	Path value: 165422.21986860037
	Path value per CP: 3676.0493304133415
_______________________________________________________________________________________________________________
Start: Calpheon | End: Heidel
	Node CP cost: 7
	Subnode CP cost: 5
	Total CP cost: 12
	Path value: 42284.31983745098
	Path value per CP: 3523.693319787582
_______________________________________________________________________________________________________________
Start: Heidel | End: Velia
	Node CP cost: 13
	Subnode CP cost: 9
	Total CP cost: 22
	Path value: 71020.9696764946
	Path value per CP: 3228.225894386118
_______________________________________________________________________________________________________________
Combining paths...
Done
Cleaning subnode dataframes...
Done
_______________________________
Node CP: 33
Subnode CP: 31
Total CP: 64
Total value: 213739.60967189074
Value per CP: 3339.6814011232927
</code></pre></div></div>



      <footer class="site-footer">
  <span class="site-footer-owner"><a href="http://localhost:4000">cwong8.github.io</a> is maintained by <a href="https://github.com/cwong8">Christopher Wong</a>.</span>
  <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
</footer>


    </section>

  </body>
</html>
